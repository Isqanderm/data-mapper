name: Benchmark

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  deployments: write
  pull-requests: write

jobs:
  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Install benchmark dependencies
        run: cd benchmarks && npm ci

      - name: Build benchmarks
        run: cd benchmarks && npm run build

      - name: Run simple benchmark
        run: cd benchmarks && node build/benchmarks/simple/Mapper.performance-benchmark.js > ../benchmark-simple.txt

      - name: Run complex benchmark
        run: cd benchmarks && node build/benchmarks/complex/Mapper.performance-benchmark.complex.js > ../benchmark-complex.txt

      - name: Parse benchmark results
        id: parse-results
        run: |
          # Extract JSON from benchmark output (last 13 lines contain the JSON array)
          cd benchmarks
          node build/benchmarks/simple/Mapper.performance-benchmark.js 2>&1 | tail -n 13 > ../bench-results.json
          echo "Benchmark results:"
          cat ../bench-results.json

      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        if: github.event_name != 'pull_request'
        with:
          name: Benchmark.js Performance
          tool: 'benchmarkjs'
          output-file-path: bench-results.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          # Show alert with commit comment on detecting possible performance regression
          alert-threshold: '150%'
          comment-on-alert: true
          fail-on-alert: false
          alert-comment-cc-users: '@Isqanderm'
          # Enable Job Summary for PRs
          summary-always: true

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            bench-results.json
            benchmark-simple.txt
            benchmark-complex.txt
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const simpleResults = fs.readFileSync('benchmark-simple.txt', 'utf8');
            const complexResults = fs.readFileSync('benchmark-complex.txt', 'utf8');

            const body = `## ðŸ“Š Benchmark Results

            ### Simple Mapping
            \`\`\`
            ${simpleResults}
            \`\`\`

            ### Complex Transformations
            \`\`\`
            ${complexResults}
            \`\`\`

            *Benchmarked with Benchmark.js on Node.js 20*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

